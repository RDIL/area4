osx_instance:
  image: mojave-xcode-10.1

Tests_task:
  # Don't run on Python2 branch:
  only_if: $CIRRUS_BRANCH != 'python-2-supported'
  # Do not skip if new commits are pushed to master:
  auto_cancellation: $CIRRUS_BRANCH != 'master'

  # Cache npm modules:
  npm_Modules_cache:
    folder: $(npm root -g)

  # Install Python3 and NodeJS:
  Install_Python_script:
    - brew install python@3
  Install_NodeJS_script:
    - brew install node

  # Clean workspace:
  Clean_Workspace_script:
    - make clean

  # Install test dependencies:
  Install_Test_Dependencies_script:
    - make testrequirements
    - make devrequirements

  # Build the package:
  Build_Package_script:
    - make dist

  # Install new beta build:
  Install_Beta_Build_script:
    - make beta

  # Test the Python code:
  Run_Python_Tests_script:
    - make test

  # Run Python linting:
  PyDocStyle_script:
    - make pydocstyle
  PyCodeStyle_script:
    - make pycodestyle
  Flake8Style_script:
    - make flake8
  PylintStyle_script:
    - make pylint

  # Test dependencies for security issues:
  Dependency_Security_Test_script:
    - make safetyci

  # Install Markdown linter:
  InstallLinter_script:
    - make installmdlint

  # Install Markdown link checker:
  Install_Link_Checker_script:
    - make installlinkcheck

  # Lint Markdown:
  Markdown_Lint_script:
    - find . -name '*.md' -exec markdownlint --config=.markdownlint.yml {} \;

  # Check links in markdown:
  Link_Check_script:
    - make linkcheck
